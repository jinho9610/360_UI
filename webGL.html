<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360classroom</title>
    <link rel = "stylesheet" type="text/css" href="{{ url_for('static', filename='css/styleGL.css') }}" />
    <script src="{{url_for('static', filename='js/three.min.js')}}"></script>
    <script src="{{url_for('static', filename='js/script_js.js')}}"></script>

</head>
<body>
    <div class="container">
        <div class="header">
            <h1><a href="#">360 Twin Classroom</a></h1>                                                                                                                                                                                                                                                                                       
            <div class="nav">
                <ul>
                    <li><a href="#">Home</a></li>
                     <li><a href="#">소개</a></li>
                    <li><a href="#">출결현황</a></li>
                </ul>
            </div>
        </div>
      
      <div class="containerBox">
         <div class="containerBox1">
            <canvas id = "canvasID"> </canvas>
                
                    <form action="/" method="GET">
                        <a href="/virtualSpatial" class="card-link">virtualSpatial</a>
                    </form>
                
                    <form action="/" method="GET">
                        <a href="/realSpatial" class="card-link2">realSpatial</a>
                    </form>
         </div>
      </div>
    </div>
    
    <script type="module">
        import { OBJLoader } from 'https://threejsfundamentals.org/threejs/resources/threejs/r127/examples/jsm/loaders/OBJLoader.js';
        import { MTLLoader } from 'https://threejsfundamentals.org/threejs/resources/threejs/r127/examples/jsm/loaders/MTLLoader.js';
        import { OrbitControls } from 'https://threejsfundamentals.org/threejs/resources/threejs/r127/examples/jsm/controls/OrbitControls.js';

        const scene = new THREE.Scene(); // scene은 전역 변수로 고정
        const objLoader = new OBJLoader(); // 오브젝트 파일 로더
        const mtlLoader = new MTLLoader();
        const loader = new THREE.TextureLoader(); // 텍스처 로더

        function makeInstance(geometry, color, x) {
            const material = new THREE.MeshPhongMaterial({ color });

            const cube = new THREE.Mesh(geometry, material);
            scene.add(cube);
            cube.position.x = x;

            return cube;
        }

        function draw_line(color, x1, y1, z1, x2, y2, z2) {
            const material = new THREE.LineBasicMaterial({
                color: color
            });

            const points = [];
            points.push(new THREE.Vector3(x1, y1, z1));
            points.push(new THREE.Vector3(x2, y2, z2));

            const geometry = new THREE.BufferGeometry().setFromPoints(points);

            const line = new THREE.Line(geometry, material);
            scene.add(line);
        }

        function draw_axis() {
            draw_line(0xff0000, 10, 0, 0, 0, 0, 0); // x8-0
            draw_line(0x00ff00, 0, 10, 0, 0, 0, 0); // y
            draw_line(0x0000ff, 0, 0, 10, 0, 0, 0); // z
        }

        function resizeRendereToDisplaySize(renderer) {
            const canvas = renderer.domElement;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            const needResize = canvas.width !== width || canvas.heigth !== height;
            if (needResize) {
                renderer.setSize(width, height, false);
            }
            return needResize;
        }

        function obj_load(path) {

            objLoader.load(path, (root) => {
                scene.add(root);
            });
        }

        function obj_load_with(path1, path2) {
            mtlLoader.load(path1, (mtl) => {
                mtl.preload();
                const objLoader = new OBJLoader();
                objLoader.setMaterials(mtl);
                objLoader.load(path2, (root) => {
                    scene.add(root);
                });
            });
        }



        // function make_classroom(renderer) {
        //     const texture = loader.load(

        //         'static/images/class_tex_front.jpg',
        //         () => {
        //             const rt = new THREE.WebGLCubeRenderTarget(texture.image.height);
        //             rt.fromEquirectangularTexture(renderer, texture);
        //             scene.background = rt.texture;
        //         });
        // }

        function main() {
            // 내가 원하는 위치의 canvas에 project 띄우기
            const canvas = document.querySelector('#canvasID');

            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true });

            const fov = 80;
    const aspect = canvas.width / canvas.height;  // the canvas default
    const near = 0.1; // near와 far는 카메라로부터의 거리
    const far = 2500;
    const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
    camera.position.x = -11
    const controls = new OrbitControls(camera, canvas);
    controls.target.set(0, 0, 0);
    controls.update();

    const boxWidth = 2000;
    const boxHeight = 1000;
    const boxDepth = 2000;
    const geometry = new THREE.BoxGeometry(boxWidth, boxHeight, boxDepth);

    //const material = new THREE.MeshBasicMaterial({ color: 0x44aa88 });  // greenish blue
    const materials = [
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/px.png') }),
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/nx.png') }),
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/py.png') }),
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/ny.png') }),
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/pz.png') }),
        new THREE.MeshBasicMaterial({ side: THREE.BackSide, map: loader.load('static/images/nz.png') }),
    ];
    //const material = new THREE.MeshPhongMaterial({ color: 0x44aa88 }); // 광원에 반응하는 머터리얼
    const cube = new THREE.Mesh(geometry, materials);
    console.log(cube.position.x);
    //cube.rotation.y = 40;
    cube.position.x = 100;
    cube.position.y = 0;
    console.log(cube.position.x);
    scene.add(cube);

            // 광원 생성
            const color = 0xffffff; // 
            const intensity = 1.5;
            const amb_light = new THREE.AmbientLight(color, intensity);
            // 광원 위치 // target은 조명이 향하는 곳임 디폴트는 둘다 (0, 0,0)
            scene.add(amb_light);

            draw_axis();

            //make_classroom(renderer);
             obj_load_with('static/material/HyeonTae.mtl', 'static/obj/HyeonTae.obj');
             obj_load_with('static/material/Useong.mtl', 'static/obj/Useong.obj');
             obj_load_with('static/material/JinHo.mtl', 'static/obj/JinHo.obj');
             obj_load_with('static/material/JooHyeong.mtl', 'static/obj/JooHyeong.obj');
             obj_load_with('static/material/JeaHyeon.mtl', 'static/obj/JeaHyeon.obj');
             
             //obj_load_with('static/material/Board.mtl', 'static/obj/Board.obj');

            function render(time) {
                time *= 0.001;

                if (resizeRendereToDisplaySize(renderer)) {
                    const canvas = renderer.domElement;
                    camera.aspect = canvas.clientWidth / canvas.clientHeight; // 가로세로 비 갱신
                    camera.updateProjectionMatrix(); // 투영 행렬 업데이트
                }

                renderer.render(scene, camera);
                requestAnimationFrame(render);
            }
            requestAnimationFrame(render); // 루프 시작
        }



        function mymain(vars) {
            //console.log('data');
            for (var v in vars) {
                console.log(v);
                console.log(vars[v]);
            }
        }

        var textMesh1 = new THREE.DText({
        text: "hyeontae",
        _3d:true,
        color: 0xffffff
        });     
        
        var textMesh2 = new THREE.DText({
        text: "jaehyeon",
        _3d:true,
        color: 0xffffff,
        });

        var textMesh3 = new THREE.DText({
        text: "jinho",
        _3d:true,
        color: 0xffffff
        });   

        var textMesh4 = new THREE.DText({
        text: "joohyeong",
        _3d:true,
        color: 0xffffff
        });   

        var textMesh5 = new THREE.DText({
        text: "yoosung",
        color: 0xffffff,
        curveSegments: 90,
        _3d:true
        });   

        var RtextMesh1 = new THREE.DText({
        text: "hyeontae",
        _3d:true,
        color: 0x000000 
        });     
        
        var RtextMesh2 = new THREE.DText({
        text: "jaehyeon",
        _3d:true,
        color: 0x000000 
        });

        var RtextMesh3 = new THREE.DText({
        text: "jinho",
        _3d:true,
        color: 0x000000 
        });   

        var RtextMesh4 = new THREE.DText({
        text: "joohyeong",
        _3d:true,
        color: 0x000000 
        });   

        var RtextMesh5 = new THREE.DText({
        text: "yoosung",
        color: 0x000000,
        _3d:true
        });   


        function text(vars){
            for (var v in vars) {
                if (vars['hyeontae'] == 'o')
                {
                    scene.remove(RtextMesh1)
                    textMesh1.size =  20;
                    textMesh1.rotation.y = 0;
                    textMesh1.position.x=110;
                    textMesh1.position.y=37;
                    textMesh1.position.z=-80;
                    
                    scene.add( textMesh1 );
                }
                else
                {
                    scene.remove(textMesh1)
                    RtextMesh1.size =  20;
                    RtextMesh1.position.x=110;
                    RtextMesh1.position.y=37;
                    RtextMesh1.position.z=-80;
                    RtextMesh1.rotation.y = 20;
                    scene.add( RtextMesh1 );
                }

                if (vars['jaehyeon'] == 'o')
                {
                    scene.remove(RtextMesh2)
                    textMesh2.size =  20;
                    textMesh2.position.x=110;
                    textMesh2.position.y=37;
                    textMesh2.position.z=80;
                    textMesh2.rotation.y = 20;
                    scene.add( textMesh2 );
                }
                else
                {
                    scene.remove(textMesh2)
                    RtextMesh2.size =  20;
                    RtextMesh2.position.x=110;
                    RtextMesh2.position.y=37;
                    RtextMesh2.position.z=80;
                    RtextMesh2.rotation.y = 20;
                    scene.add( RtextMesh2 );
                }

                if (vars['jinho'] == 'o')
                {
                    scene.remove(RtextMesh3)
                    textMesh3.size =  20;
                    textMesh3.position.x=30;
                    textMesh3.position.y=37;
                    textMesh3.position.z=-80;
                    textMesh3.rotation.y = 20;
                    scene.add( textMesh3 );
                }
                else
                {
                    scene.remove(textMesh3)
                    RtextMesh3.size =  20;
                    RtextMesh3.position.x=30;
                    RtextMesh3.position.y=37;
                    RtextMesh3.position.z=-80;
                    RtextMesh3.rotation.y = 20;
                    scene.add( RtextMesh3 );
                }


                if (vars['joohyeong'] == 'o')
                {
                    
                    scene.remove(RtextMesh4)
                    textMesh4.size =  20;
                    textMesh4.position.x=30;
                    textMesh4.position.y=37;
                    textMesh4.position.z=80;
                    textMesh4.rotation.y = 20;
                    scene.add( textMesh4 );
                    
                }
                else
                {
                    scene.remove(textMesh4)
                    RtextMesh4.size =  20;
                    RtextMesh4.position.x=30;
                    RtextMesh4.position.y=37;
                    RtextMesh4.position.z=80;
                    RtextMesh4.rotation.y = 20;
                    scene.add( RtextMesh4 );
                }

                if (vars['yoosung'] == 'o')
                {
                    scene.remove(RtextMesh5)
                    textMesh5.size =  20;
                    textMesh5.position.x=-50;
                    textMesh5.position.y=37;
                    textMesh5.position.z=-80;
                    textMesh5.rotation.y = 20;
                    scene.add( textMesh5 );
                }
                else
                {
                    scene.remove(textMesh5)
                    RtextMesh5.size =  2;
                    RtextMesh5.position.x=-50;
                    RtextMesh5.position.y=37;
                    RtextMesh5.position.z=-80;
                    RtextMesh5.rotation.y = 20;
                    scene.add( RtextMesh5 );
                }
            }        
        }
        
        function keyDownHandler(e) {
            if(e.keyCode == 37) { //Arrow Left
                camera.position.x = +10;

            }
            else if(e.keyCode == 38) {  // Arrow Up
                camera.position.y = +10;

            }
            else if(e.keyCode == 39) {  // Arrow Right
                camera.position.x = -10;

            } 
            else if(e.keyCode == 40) {  // Arrow Down
                camera.position.y = -10;

            }
            else if(e.keyCode == 88) {  // 하늘로
                camera.position.z = +10;
            }
            else if(e.keyCode == 89) {  
                camera.position.z = -10;
            }
        }    


        window.addEventListener('keydown', (e) => {
            keyDownHandler(e);
        });
        window.addEventListener('keyup', (e) => {
            keyUpHandler(e);
        });  
            


        var i = 1;
        const source = new EventSource("/video_info_streaming");
                source.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    //console.log(data);
                    //mymain(data);
                    text(data);

                }

        main();

    </script>

</body>
</html> 